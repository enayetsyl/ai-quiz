name: Deploy Backend to EC2 (Option 1)

on:
  push:
    branches: ["main"]
    # Optional: limit to backend changes
    # paths:
    #   - "apps/api/**"
    #   - ".github/workflows/deploy-backend.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH Deploy to EC2 (run deploy.sh)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          script_stop: true
          script: |
            set -euo pipefail
            cd ~/ai-quiz/apps/api
            chmod +x deploy.sh
            ./deploy.sh

      - name: SSH Run Prisma migrations and health check
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          script_stop: true
          script: |
            set -euo pipefail
            ENV_FILE="${{ secrets.ENV_FILE || '/home/ec2-user/quiz-generation-deploy/.env' }}"
            HEALTH_URL="${{ secrets.HEALTH_URL || 'http://localhost:4080/healthz' }}"

            echo "Running Prisma migrations..."
            # Prefer running inside the already built/running api container to avoid path issues
            if command -v docker-compose >/dev/null 2>&1; then
              DC="docker-compose"
            else
              DC="docker compose"
            fi

            # Ensure we're in the API directory that has docker-compose.prod.yml
            if [ -d "$HOME/ai-quiz/apps/api" ] && [ -f "$HOME/ai-quiz/apps/api/docker-compose.prod.yml" ]; then
              cd "$HOME/ai-quiz/apps/api"
            elif [ -d "$HOME/ai-quiz/apps/api" ] && [ -f "$HOME/ai-quiz/apps/api/docker-compose.prod.yml" ]; then
              cd "$HOME/ai-quiz/apps/api"
            else
              echo "Could not locate apps/api with docker-compose.prod.yml" >&2
              exit 1
            fi

            # Try inside container first; fall back to docker run with current directory mounted
            if ! $DC -f docker-compose.prod.yml exec -T api-server sh -lc "npx prisma migrate deploy && npx prisma generate"; then
              echo "Falling back to docker run method..."
              docker run --rm \
                --env-file "$ENV_FILE" \
                -v "$(pwd)":/app \
                -w /app \
                node:20-alpine sh -c "
                  apk add --no-cache python3 make g++ &&
                  npm ci &&
                  npx prisma migrate deploy &&
                  npx prisma generate
                "
            fi

            echo "Health check..."
            max_tries=12
            sleep_between=5
            for i in $(seq 1 ${max_tries}); do
              if curl -fsS "$HEALTH_URL" > /dev/null; then
                echo "Health check passed."
                exit 0
              fi
              echo "Attempt ${i}/${max_tries} failed; retrying in ${sleep_between}s..."
              sleep ${sleep_between}
            done
            echo "Health check failed after ${max_tries} attempts"
            exit 1
